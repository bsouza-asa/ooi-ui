{% extends "base.html" %}

{% block title %}
  <title>Welcome to OOI</title>
{% endblock %}

{% block head %}
  
  <!-- Map Stuff -->
  <link rel="stylesheet" href="/components/leaflet/dist/leaflet.css"/>
  <script src="/components/leaflet/dist/leaflet.js"></script>

  <script src="/components/d3/d3.min.js"></script>
  <link rel="stylesheet" href="/components/Leaflet.awesome-markers/dist/leaflet.awesome-markers.css">
  <script src="/components/Leaflet.awesome-markers/dist/leaflet.awesome-markers.js"></script>

  <link rel="stylesheet" href="/css/index.css">
  <script src="/js/ooi/map.js"></script>

  <!-- Marker Cluster -->
  <script src="/components/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="/components/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="/components/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <!-- Marker Cluster -->

  <!--
  Date Time
  -->    
  <link rel="stylesheet" href="/components/bootstrap3-datetimepicker/build/css/bootstrap-datetimepicker.min.css">
  <script src="/components/moment/moment.js"></script> 
  <script src="/components/bootstrap3-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script> 


  <script src="/js/ooi/plot.js"></script> 
  <script src="/js/ooi/variable_list.js"></script> 
  <script src="/js/ooi/d3.legend.js"></script> 
  <link rel="stylesheet" href="/css/ooi/plot.css">
  
  <!-- Everything for fancy tree -->
  <link href="/components/fancytree/dist/skin-bootstrap/ui.fancytree.css" rel="stylesheet" type="text/css" class="skinswitcher">

  <script src="/components/fancytree/dist/src/jquery.fancytree.js" type="text/javascript"></script>
  <script src="/components/fancytree/dist/src/jquery.fancytree.edit.js" type="text/javascript"></script>
  <script src="/components/fancytree/dist/src/jquery.fancytree.glyph.js" type="text/javascript"></script>
  <script src="/components/fancytree/dist/src/jquery.fancytree.wide.js" type="text/javascript"></script>
  <script src="/components/fancytree/dist/src/jquery.fancytree.filter.js" type="text/javascript"></script>
  <script src="/components/fancytree/dist/src/jquery.fancytree.childcounter.js" type="text/javascript"></script>
  <!-- end fancy-tree -->

  <link rel="stylesheet" href="/css/toc_menu.css" />
  <script src="/js/ooi/toc_menu.js"></script>

{% endblock %}

{% block body %}


    <!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="{{ erddap_url }}/info/index.html?page=1&itemsPerPage=1000"><span class="glyphicon glyphicon-hdd" aria-hidden="true"></span> Data Catalog</a></li>            

            <li class="dropdown">               
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Array List <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li class="dropdown-header">Pioneer</li>
                <li><a href="/pioneer/">Array Overview</a></li>               
                <li class="divider"></li>
                <li class="dropdown-header">Other</li>
                <!--
                <li><a href="#">Separated link</a></li>
                <li><a href="#">One more separated link</a></li>
                -->
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">

            <li>
                <img src="/img/OOI_BannerNew_01.png" style="width:85px;">
            </li>
            <li>
                <img src="/img/nsf-logo.png" style="width:50px;">
            </li>
            <li>
               <img src="/img/OceanLeadershipLogoCS2.png" style="width:75px;">
            </li>
            <!--
            <div class="col-sm-4" style="padding-top:8px">
                <li>
                    <a class="btn btn-social-icon btn-twitter">
                        <i class="fa fa-twitter"></i>
                    </a>
                </li>
            </div>
            <div class="col-sm-4" style="padding-top:8px">
                <li>
                    <a class="btn btn-social-icon btn-facebook">
                        <i class="fa fa-facebook"></i>
                    </a>
                </li>
            </div>
            -->
            <!--
            <li><a href="../navbar/">Default</a></li>
            <li><a href="../navbar-static-top/">Static top</a></li>
            <li class="active"><a href="./">Fixed top</a></li>
            -->
          </ul>

          <div class="row ">
            <div class="col-lg-12">
                <div class="panel">   <!-- removed panel-default-->
                  <div class="array-row">  <!-- removed panel-body-->
                    <div class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="active btn btn-info array-btn" array="all">All</button>
                        <button type="button" class="btn btn-default array-btn" array="ce" disabled="disabled">Endurance Array (CE)</button>
                        <button type="button" class="btn btn-default array-btn" array="gp" disabled="disabled">Station PAPA (GP)</button>
                        <button type="button" class=" btn btn-default array-btn" array="cp">Pioneer Array (CP)</button>
                        <button type="button" class="btn btn-default array-btn" array="ga" disabled="disabled">Global Argentine (GA)</button>
                        <button type="button" class="btn btn-default array-btn" array="rs" disabled="disabled">RS Regional (RS)</button>
                        <button type="button" class="btn btn-default array-btn" array="gi" disabled="disabled">Global Irminger Sea (GI)</button>
                        <button type="button" class="btn btn-default array-btn" array="gs" disabled="disabled">55 South (GS)</button>
                        <button type="button" class="btn btn-default array-btn" array="ssf" disabled="disabled">Shore Side Facilities (SSF)</button>
                    </div>
                    </div>
                  </div>
                </div>
            </div>
        </div>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div id="wrapper">
    <div class="container-full">
        <!--/.banner -->
        <!--
        <div class="row">       
            <div class="col-sm-4">
                <img src="/img/nsf-logo.png" class="img-rounded" style="width:100px;height:100px">
            </div>

            <div class="text-center">
                <div class="col-sm-4">
                    <img src="/img/OOI_BannerNew_01.png" class="img-rounded">
                </div>
            </div>

            <div class="col-sm-4"> 
                <div class="pull-right">
                    <img src="/img/OceanLeadershipLogoCS2.png" class="img-rounded" style="width:150px;height:100px">            
                </div>
            </div>
        </div>
        -->

        <!--/.Array Names -->
        <!--
        <div class="row ">
            <div class="col-lg-12">
                <div class="panel">   
                  <div class="array-row">  
                    <div class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="active btn btn-info array-btn" array="all">All</button>
                        <button type="button" class="btn btn-default array-btn" array="ce" disabled="disabled">Endurance Array (CE)</button>
                        <button type="button" class="btn btn-default array-btn" array="gp" disabled="disabled">Station PAPA (GP)</button>
                        <button type="button" class=" btn btn-default array-btn" array="cp">Pioneer Array (CP)</button>
                        <button type="button" class="btn btn-default array-btn" array="ga" disabled="disabled">Global Argentine (GA)</button>
                        <button type="button" class="btn btn-default array-btn" array="rs" disabled="disabled">RS Regional (RS)</button>
                        <button type="button" class="btn btn-default array-btn" array="gi" disabled="disabled">Global Irminger Sea (GI)</button>
                        <button type="button" class="btn btn-default array-btn" array="gs" disabled="disabled">55 South (GS)</button>
                        <button type="button" class="btn btn-default array-btn" array="ssf" disabled="disabled">Shore Side Facilities (SSF)</button>
                    </div>
                    </div>
                  </div>
                </div>
            </div>
        </div>
        -->

        <!--/.content -->
        <div class="row">
            <div class="col-lg-4">
                <div class="panel panel-default">
                  <div class="panel-body" style="padding:1px;">
                    <div>                       

                        <h4 style="text-align: center;">Array Overview 
                            <i id="array-overview-info" class="glyphicon glyphicon-info-sign info-icon"></i>
                        </h4>   

                        <div style="padding:5px;" class="col-1 input-group">
                               <div class="right-inner-addon">
                                   <input id="searchQuery" type="Search" placeholder="Search..." class="form-control" />
                                   <i class="glyphicon glyphicon-search"></i>                               
                                </div>
                                   <div class="input-group-btn">
                                       <button id="search-reset" type="button" class="btn btn-info">
                                            <span class="glyphicon glyphicon-remove-sign"></span>
                                       </button>
                                   </div>
                        </div>
                                    
                        <!--
                        <div style="padding:5px">
                            <div id="statusfilter" class="btn-group">
                                <button filtertype="status" filter="all" class="active filterMapBtn btn btn-info btn-sm" type="button">
                                  All
                                </button>

                                <button filtertype="status" filter="na" class="filterMapBtn btn btn-primary btn-sm" type="button">
                                  NA
                                </button>

                                <button filtertype="status" filter="on" class="filterMapBtn btn btn-success btn-sm" type="button">
                                  ON
                                </button>

                                <button filtertype="status" filter="off" class="filterMapBtn btn btn-danger btn-sm" type="button">
                                  OFF
                                </button>
                            </div>  
                        </div>                  
                        -->
                       
                        <div id="tocmenusection" class="toc-panel">                         
                        </div>

                        <!--                                                 
                        <h4 style="padding-top:20px;text-align: center;">Array Breakdown 
                            <i class="glyphicon glyphicon-info-sign info-icon"></i>
                        </h4>
                        
                        <div id="donut-example" style="text-align: center;">
                        </div>   
                        -->   
                    </div>
                  </div>
                </div>
            </div>
            
            <div class="col-lg-8 fill">
                <div class="panel panel-default" style="height: 100%">
                  <div class="panel-body" style="height: 100%;padding:5px;">
                    <div id="map" style="width: 100%; min-height: 400px;height:500px;"></div>
                  </div>
                </div>
            </div>

            <div class="row">

            </div>  

            <div class="col-lg-7 bottom-div">
                <div class="panel panel-default">
                    <div class="panel-body" style="padding:5px;">     

                    <div id="processing-icon" class="spinner">
                      <div class="dot1"></div>
                      <div class="dot2"></div>
                    </div>                                       

                    <div class="container-fluid" id="plotting" style="display: none; min-height: 300px;height:300px;">  
                                        
                    </div>
                  </div>
                </div>
            </div>

            <div class="bottom-div col-lg-5">
                <div class="panel panel-default" style="height: 100%">
                  <div class="panel-body" style="height: 100%;padding:5px;">
                        
                        <div class="row">                            
                            <div class="col-lg-6" style="display: inline-block;">
                                <h4>Station Info</h4>
                                <dt>Array</dt>
                                <dd id="currentArray"></dd>
                                <dt>Platform</dt>
                                <dd id="currentPlatform"></dd>                         
                                <dt>Intrument</dt>
                                <dd id="currentInstrument"></dd>
                                <h4>Date Controls</h4>
                                <div class="col-lg-8">
                                    <div class='row'>
                                        <div class="form-group">
                                            <div class='input-group date' id='datetimepicker_from'>
                                                <input type='text' class="form-control" />
                                                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class='row'>
                                        <div class="form-group">
                                            <div class='input-group date' id='datetimepicker_to'>
                                                <input type='text' class="form-control" />
                                                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-lg-12 row">                                                                        
                                    <p>
                                        <h5>Time Averaged</h5>
                                        <input id="switch-time-average-check" name="switch-time-average" type="checkbox"  data-on-color="info" data-on-text="ON" data-off-text="OFF" checked>
                                        <i id="time-average-info" class="glyphicon glyphicon-info-sign info-icon"></i>
                                    </p>

                                    <h5>Time Interval</h5>
                                    <div class="btn-group" role="group" aria-label="...">
                                      <button type="button" class="btn btn-info active">1 hour</button>
                                      <button type="button" disabled class="btn btn-default">1 day</button>
                                      <button type="button" disabled class="btn btn-default">1 month</button>
                                    </div>
                                    
                                    <div>
                                        <p>
                                            <button id="refresh-plot-button" type="button" class="btn btn-primary btn">
                                              <span style="display: none" id="refresh-plot-icon" class="fa fa-spinner fa-spin" aria-hidden="true"></span> Plot
                                            </button>   
                                        </p>
                                    </div>
                                                                    
                                </div> 
                                
                            </div>

                            <div class="col-lg-6" style="display: inline-block;">
                                <h4>Plot Controls</h4>
                                <h5 class="text-left">Streams</h5>
                                <div class="col-lg-11" "row">
                                    <select id="stream-select"class="form-control">
                                    </select>                                
                                </div>
                                <div class="col-lg-11 row" style="margin-left:0px;margin-right:15px">                                
                                    <h5 class="text-left">Variables</h5>
                                    <div class="panel" style="max-height: 300px;overflow: auto; border-color: lightgray lightgray;border-style: solid;">
                                        <ul id="variable-select-list" class="list-group checked-list-box">
                                          <li class="list-group-item">Cras justo odio</li>
                                          <li class="list-group-item" data-checked="true">Dapibus ac facilisis in</li>
                                        </ul>
                                    </div>
                                </div>                                                                
                            </div>                                                                                 
                        </div>                         
                                                 
                  </div>                        
                </div>                
            </div>

            
            
        </div>
    </div>
    </div>

    <div id="tilepopovertitle" style="display: none">            
    </div> 

    <div id="tilepopovercontent" style="display: none">            
    </div> 

    <script>
    /* TEMPO ARRAY LIST*/
    array_list = {}
    array_list_all ={'lat':41.505,'lon':-80.09,"zoom":3}
    array_list['ce']={'name':'Endurance Array (CE)',"num":14,'lat':44.37,'lon':-124.95,"zoom":3}
    array_list['gp']={'name':'Station PAPA (GP)',"num":6,'lat':49.9795,'lon':-144.254,"zoom":3}
    array_list['cp']={'name':'Pioneer Array (CP)',"num":16,'lat':40.1,'lon':-70.88,"zoom":8}
    array_list['ga']={'name':'Global Argentine (GA)','num':7,'lat':-42.5073,'lon':-42.8905,"zoom":3}
    array_list['rs']={'name':'RS Regional','num':11,'lat':44.554,'lon':-125.352,"zoom":3}
    array_list['gi']={'name':'Global Irminger Sea (GI)','num':7,'lat':60.4582,'lon':-38.4407,"zoom":3}
    array_list['gs']={'name':'55 South (GS)','num':7,'lat':-54.0814,'lon':-89.6652,"zoom":3}
    array_list['gs']={'name':'55 South (GS)','num':7,'lat':-54.0814,'lon':-89.6652,"zoom":3}

    var map = L.map('map',{
        center: [41.505, -80.09],
        zoom: 3,
        maxZoom: 10
    });

    setupTileLayers(map)    

    var markers = new L.MarkerClusterGroup();    

    L.MarkerClusterGroup.include({ 

        resetMarkers: function (filter) {            
            var new_markers = Array();                        
            for (var i = 0; i < this._marker_list.length; i++) {      
                marker = this._marker_list[i]
                status = marker.options.status
                if (filter == "all"){
                    new_markers.push(marker);
                }
                else if (status == filter){
                    new_markers.push(marker);
                }
            }
            this.clearLayers();
            this.addLayers(new_markers);
            this.setfilteredMarkers(new_markers)
        },
        setfilteredMarkers: function (filteredMarkers) {
            this._filtered_marker_list = filteredMarkers;
        },    

        setMarkers: function (marker_list) {
            this._marker_list = marker_list;
            this.setfilteredMarkers(marker_list)            
        },

        filter: function (filter,filterType) {            
            //f = f || function (m) { return true; }                                         
            var new_markers = Array();           

            for (var i = 0; i < this._filtered_marker_list.length; i++) {
                marker = this._marker_list[i]                
                status = marker.options.status
                //platform = marker.options.platform
                //instrument = marker.options.instrument   
                platform_id = marker.options.platform_id
                instrument_id = marker.options.instrument_id                                               

                if (filter == "all"){                    
                    this.resetMarkers();
                }else{
                    if (filterType == "status"){                    
                        if (status == filter){
                            new_markers.push(marker);
                    }

                    }else if (filterType == "platform"){                                  
                        if (platform_id == filter){
                            new_markers.push(marker);
                        }
                    }else if (filterType == "instrument"){                    
                        if (instrument_id == filter){
                            new_markers.push(marker);
                        }
                    }
                }
            };
            this.setfilteredMarkers(new_markers)
            this.clearLayers();
            this.addLayers(new_markers);            
        }    
    });

    addMarkers(map,markers);

    /*
    USED FOR STATUS
    */
    function getStatusFilter(){
        return "all"
        //return $('#statusfilter').find( '.active' ).attr( "filter" )         
    }         

    $('#tocmenusection').on('click', function (e) {
        //Filter map by TOC
                
            
        var node = $("#tocmenusection").fancytree("getActiveNode");
        if ((typeof(node) !== 'undefined') && (node !== null)) {
            node_name = node.title
            node_id = node.data.id
            //gets the node list 
            var ll = node.getParentList(includeRoot=false, includeSelf=false)

            //allow filtering at different levels
            request_level = node.getLevel()
            if (request_level == 1){
                //platform
                filterType="platform"
                filter = node_id
            }else if (request_level == 2){
                //instrument
                filterType="instrument"
                filter = node_id
            }else if (request_level == 3){
                //stream = instrument
                filterType="instrument"
                filter = ll[1].data.id
            }else if (request_level == 4){
                //parameter = instrument
                filterType="instrument"
                filter = ll[1].data.id
            }

            //reset the filters
            markers.resetMarkers(getStatusFilter());    
            //apply the marker filter                            
            markers.filter(filter,filterType);
        }
    });
    

    $('.array-btn').on('click', function (e) {
        
        var array = $( this ).attr( "array" )       

        $(this).addClass('active').siblings().removeClass('active');

        
        if (array == "all"){
            lat  = array_list_all['lat']
            lon  = array_list_all['lon']          
            zoom = array_list_all['zoom']
        } else{
            lat = array_list[array]['lat']
            lon = array_list[array]['lon']          
            zoom = array_list[array]['zoom']
        }      
        map.setView([lat, lon], zoom);   

    });

    $('.info-icon').popover({
        trigger: "hover",
        html:true,
        placement:'bottom',
        title: function() {
            console.log($(this).attr('id'))
            if ($(this).attr('id') == "array-overview-info"){
                return ("<b>Array Overview</b>")
            }
            else if($(this).attr('id') == "time-average-info"){
                return ("<b>Time Average Overview</b>")
            } 

            return ""
        },
        content: function() {
            console.log($(this).attr('id'))
            if ($(this).attr('id') == "array-overview-info"){
                return ('<div class="popovertext">'+
                            'Displays the Platforms and Instruments. Allows the user to enter a keyword search'+
                        '</div>')
            }
            else if($(this).attr('id') == "time-average-info"){
                return ('<div class="popovertext">'+
                            '(ON) Allows the user to average the data by a given temporal extent<br>'+
                            '(OFF) Returns the raw data without a time average applied (up to the max number of points)'+
                        '</div>')
            } 
            return ""
        }
    });

    $("[name='switch-time-average']").bootstrapSwitch();
    
    $( document ).ready(function() {        
        $( "#searchQuery" ).keyup(function() {
            match = $( "#searchQuery" ).val()
            var tree = $("#tocmenusection").fancytree("getTree");            
            n = tree.filterNodes(match, false);
        }); 


        $( "#search-reset" ).on('click',function(){
            var tree = $("#tocmenusection").fancytree("getTree");
            $( "#searchQuery" ).val("")
            tree.clearFilter();

            try{
                var node = $("#tocmenusection").fancytree("getActiveNode");
                node.setActive(false);
            }
            catch(err) {
            }
            //reset the map marker filters
            markers.resetMarkers(getStatusFilter());   
        });    
    });
    
    $('#map').on('click', '.popup-map-btn-download', function() {
        $('.popup-map-btn-plot').click();
        var array = $( this ).parent().attr( "array" ) 
        //var instrument = $( this ).parent().attr( "instrument" )
        //var platform = $( this ).parent().attr( "platform" )

        var instrument_id = $( this ).parent().attr( "instrument_id" )
        var platform_id = $( this ).parent().attr( "platform_id" )

        var node = $("#tocmenusection").fancytree("getActiveNode");
        var stream = $('#stream-select option:selected').text();



        instrument_id = instrument_id.replace(/-/g, '_');
        console.log(instrument_id);
        var url = '{{ erddap_url }}/tabledap/' + instrument_id + '_' + stream + '.nc';
        console.log(url);
        window.open(url, '_blank');
    });

    $('#stream-select').change(function() {        
        var stream = $('#stream-select option:selected').text();
        var array = $( "#currentArray" ).text();
        var platform_id = $( "#currentPlatform" ).attr("value")
        var instrument_id = $( "#currentInstrument" ).attr("value")    
        var instrument = $( "#currentInstrument" ).text();   

        var node = $("#tocmenusection").fancytree("getActiveNode");
        console.log(instrument_id);

        var r_node = $("#tocmenusection").fancytree("getRootNode");        
        var f_node = r_node.findFirst(instrument_id)
        //if we cant find the selected node in the toc using the instrument toc title look at the nodes them selves
        if (f_node === null){
            for (var i = 0; i <  r_node.getChildren().length; i++) {                 
                 for (var j = 0; j < r_node.getChildren()[i].getChildren().length; j++) {
                    //console.log("platform:",r_node.getChildren()[i].data.id,"instrument:",r_node.getChildren()[i].getChildren()[j].data.id)

                    if (instrument_id == r_node.getChildren()[i].getChildren()[j].data.id){
                        f_node = r_node.getChildren()[i].getChildren()[j]
                        console.log(f_node)
                        break
                    }
                 };
            };
        }

        $( "#variable-select-list" ).empty();
        global_f_node = f_node;

        if (f_node.getChildren()!= null && f_node.getChildren().length>0){
            for (var i = 0; i < f_node.getChildren().length; i++) {
                var streamSomething = f_node.getChildren()[i].title;
                console.log("stream: ", streamSomething);
                console.log(f_node.getChildren()[i].title);
                if (streamSomething == stream){
                    param_list = f_node.getChildren()[i].getChildren()
                    for (var j = 0; j < param_list.length; j++) {
                        if (param_list[j].title.indexOf("time") == -1){
                          $( "#variable-select-list" ).append('<li value="'+param_list[j].id+'" class="list-group-item">'+param_list[j].title+'</li>')
                        }
                    };
                } 
            };
        }

        refreshVariableList();
        updateData(array,platform_id,instrument_id); 
    });
    
    


    /*
    when you click on the map, select a point and click plot....
    */
    //when plot is click .... .popup-map-btn-plot
    $('#map').on('click', '.popup-map-btn-plot', function() {
        console.log("map-click")
        console.log($( this ).parent())
        var array = $( this ).parent().attr( "array" ) 
        var instrument = $( this ).parent().attr( "instrument" )
        var platform = $( this ).parent().attr( "platform" )

        var instrument_id = $( this ).parent().attr( "instrument_id" )
        var platform_id = $( this ).parent().attr( "platform_id" )
        
        var node = $("#tocmenusection").fancytree("getActiveNode");
        stream_id = null
        if ((typeof(node) !== 'undefined') && (node !== null)) {
            if (node.getLevel() >= 3){                
                //used for selection of stream
                console.log(array,instrument_id,platform_id)
                stream_id = node.data.id
                console.log("STREAM!",stream_id)
            } 
        }

        var r_node = $("#tocmenusection").fancytree("getRootNode");        

        var f_node = r_node.findFirst(instrument_id)
        //if we cant find the selected node in the toc using the instrument toc title look at the nodes them selves
        if (f_node === null){
            for (var i = 0; i <  r_node.getChildren().length; i++) {                 
                 for (var j = 0; j < r_node.getChildren()[i].getChildren().length; j++) {
                    if (instrument_id == r_node.getChildren()[i].getChildren()[j].data.id){
                        f_node = r_node.getChildren()[i].getChildren()[j]
                        console.log(f_node)
                        break
                    }
                 };
            };
        }


        $( "#stream-select" ).empty();
        $( "#variable-select-list" ).empty();
        global_f_node = f_node;


        if (f_node.getChildren().length>0){
            for (var i = 0; i < f_node.getChildren().length; i++) {
                console.log(f_node.getChildren()[i].title);
                //if stream is selected try grabbing it and selecting it
                if (stream_id !==null){
                    //try and grab the stream
                    if (f_node.getChildren()[i].title == stream_id){
                        //grab the stream and the param list for it
                        $( "#stream-select" ).append('<option selected value="'+f_node.getChildren()[i].id+'">'+f_node.getChildren()[i].title+'</option>')    
                        param_list = f_node.getChildren()[i].getChildren()
                        // add the params
                        for (var j = 0; j < param_list.length; j++) {
                            if (param_list[j].title.indexOf("time") == -1){ 
                                $( "#variable-select-list" ).append('<li value="'+param_list[j].id+'" class="list-group-item">'+param_list[j].title+'</li>')
                            }
                        };

                    }else{
                        $( "#stream-select" ).append('<option value="'+f_node.getChildren()[i].id+'">'+f_node.getChildren()[i].title+'</option>')
                    }
                }else{
                    $( "#stream-select" ).append('<option value="'+f_node.getChildren()[i].id+'">'+f_node.getChildren()[i].title+'</option>')
                    if (i==0){
                        param_list = f_node.getChildren()[i].getChildren()
                        for (var j = 0; j < param_list.length; j++) {
                            if (param_list[j].title.indexOf("time") == -1){ 

                            $( "#variable-select-list" ).append('<li value="'+param_list[j].id+'" class="list-group-item">'+param_list[j].title+'</li>')

                            }
                        };
                    }
                }
                 
            };
        }

        $( "#currentArray" ).text(array);
        $( "#currentPlatform" ).text(platform);
        $( "#currentPlatform" ).attr("value",platform_id);
        $( "#currentInstrument" ).text(instrument);      
        $( "#currentInstrument" ).attr("value",instrument_id);

        refreshVariableList();
        getTimeCoverage(array,platform_id,instrument_id);  // Also updates the data because it sets the date picker
    });

    $('#variable-select-list').on('click', function(event) { 
       event.preventDefault();        
       //updateDataPlot();
    });

    //update the plot on selection
    $('#refresh-plot-button').on('click', function(event) { 
       event.preventDefault();        
       updateDataPlot();
    });


    //DATE TIME FUNCTION
    $(function () {
            $('#datetimepicker_from').datetimepicker();
            $('#datetimepicker_to').datetimepicker();
            
            $('#datetimepicker_from').data("DateTimePicker").setDate(new Date("jul 15, 2014"))

            $('#datetimepicker_to').data("DateTimePicker").setDate(new Date("jul 20, 2014"))

            $("#datetimepicker_from").on("dp.change",function (e) {
               $('#datetimepicker_to').data("DateTimePicker").setMinDate(e.date);
               updateDataPlot();
            });
            $("#datetimepicker_to").on("dp.change",function (e) {
               $('#datetimepicker_from').data("DateTimePicker").setMaxDate(e.date);
               updateDataPlot();
            });
    });


    function updateDataPlot(){
        array = $( "#currentArray" ).text();
        platform = $( "#currentPlatform" ).text();
        instrument = $( "#currentInstrument" ).text();   

        platform_id = $( "#currentPlatform" ).attr("value");
        instrument_id = $( "#currentInstrument" ).attr("value");                   
        updateData(array,platform_id,instrument_id); 
    }

    var global_f_node = null;

    </script>


{% endblock %}

